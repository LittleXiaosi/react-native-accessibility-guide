# 无障碍的相关问题汇总

## 背景

​	在最开始处理无障碍问题的时候，其实想法很简单，既然RN有现成的无障碍属性，那不就是只要把对应的属性添加上去就好了？当然现实总是要比理想骨感很多，我们实际遇到的很多问题，是无法简单的通过一两个无障碍支持的属性（更别提有的属性支持很奇怪了）以下就是我们之前遇到的一些问题的汇总

## 信息传递

*​	这类错误主要是因为信息传递不足导致的，核心原因就是因为TTS读屏的时候，不能将**屏幕语言**朗读成**日常语言**，这种情况下，信息在传递的时候，传递给视障用户的时候，可能有偏差，或者需要额外的理解成本*

###  1.金额：
   + 问题案例：显示 **2345.23**元 需要朗读为**两千三百四十五元两角三分**，或者**两千三百四十五点二三元**，但是TTS在读屏幕的时候，不一定会这么朗读，比如**两千三百四十五点二十三**这种朗读，就会比较奇怪。
   + 解决方式：金额是典型的日常用语与显示不一致的问题，这种情况下，为了保证重要金额数字朗读的准确性，需要额外转化为中文，也就是直接在`accessibilityLabel`里面写入**两千三百四十五元两角三分**直接朗读中文

###  2.时间：
   + 问题案例：显示**2020-06-20**的时候，需要朗读为**2020年6月20日**，这类信息也是明显的有固定的书写格式，明眼人看到就能够明白，但是对于TTS朗读的时候，并不会识别出这是一个时间信息
   + 解决方案：同金额处理，需要额外在`accessibilityLabel`里面添加中文

###  3.符号：
   + 问题案例：在特定内容中，**1+2*3/4-5**是需要朗读为**1加2乘3除4减5**，但是通常会朗读为**1加号2星号3斜杠45**，就是同一个符号，在不同的情况下表达的含义是不一样的，比如显示电话号码的隐藏信息时候，123***456就得读成“一二三星号星号星号星号四五六”，在这种情况下， * 就不是乘法了符号了，这种信息在我们明眼人看到的时候是很容易理解的，但是对于视障用户的话TTS是不一定能够准确判断含义，还是需要自行转化的
   + 解决方案：与金额类似，需要手动转化为中文处理
###  4.字符串数字
   1. 电话号码
   2. 银行卡号
      + 问题案例：这两种数字都是类似的问题，在正常语言环境中，我们不认为这些数字是可计算数字，所以需要额外按照字符串的处理，
      + 解决方案：把罗马数字转化为中文字符串放在`accessibilityLabel`中
###  5.语序
   + 问题案例：很多设计稿在设计的时候，不完全遵循从上到下，从左到右的默认浏览数据，尤其是一些描述文字或者角标等等。
   + 解决方案：重新在`accessibilityLabel`排列为希望展现的语序
### 6.多音字
   + 问题案例：在朗读文案的时候，多音字会导致文案意思不一致，比如“我行(xíng)走在时代的前列”，“我行(háng)走在时代的前列”，这种情况下，两句话都是对的，但是意思不一样，但是TTS是识别不了，应该读取哪种文案的
   + 解决方案：替换文案，或者直接忽略这个bug（PS：多音字是中文语言环境下的特有问题，是没有办法直接通过技术能力解决的）
### 7. 辅助文案
   + 问题案例：在用户选择到Banner图片或者是宣传图片的时候，朗读的信息其实会是**“图片”**或者是**“xxx.png”**的内容，那这部分内容是需要额外朗读出来的
   + 解决方案：添加相关描述文案，语音朗读对应的图片文案

## 属性支持

### 1. 元素角色

   + 案例：这个主要就是需要给能够响应无障碍焦点的元素添加一个说明，`accessibilityRole`属性的设置，本身并不复杂

   + 解决方案：设置`accessibilityRole`的属性为对应的元素，这样朗读的时候就有对应的文案，比如下面这种情况就会读为**"点击，按钮"**

   + ```jsx
     <TouchableOpacity accessibilityRole={'button'}>点击</TouchableOpacity>
     ```

   + 注意事项：React-Native支持的属性有二十多种，但是！！！并不是所有的属性，都有对应的中文翻译，也就是需要自行翻译，我们和深圳无障碍协会确认过之后，使用了一套比较靠谱的翻译文案，详情在另一文章中会详细讲解

### 2.元素值

   + 案例：这个主要就是针对一些带值的属性说明，`accessibilityState`属性的设置主要就是针对比如按钮可点不可点的状态，选择框当前是不是被选中的状态，滑块当前的值等等，这些也是视障用户需要知道的值
   + 解决方案：设置`accessibilityState`对应的值，就可以有对应的朗读文案，比如下面这种情况就会读为**“点击，按钮，已禁用”**（安卓）**“点击，按钮，变暗”**（iOS）
   + ```jsx
       <TouchableOpacity accessibilityRole={'button'} accessibilityState={disabled:true}>点击</TouchableOpacity>
       ```
   + 这个属性依旧有安卓和iOS不同意，中英文翻译不一致的问题，和上面的 `accessibilityRole`一样，我们也标准化了整个状态朗读的中文，解决了本地化的问题

### 3.H5代码

   + 问题案例：我们以上所有的问题，都是属于RN的优化范围，但是Webview内的无障碍优化其实是属于H5的优化范畴，所以需要H5的开发团队额外处理
   + 解决方案：遵循W3C的无障碍属性，其实相对而言，H5对无障碍的支持要比RN好一些，至少不需要自己来翻译控件名字，而且基本上现在的App

## 交互设计

### 1.读屏交互模式

   + 这个地方需要特别考虑iOS和安卓的交互模式不一样，
     + iOS没有滚动的概念，三指头滑屏幕实际上是在**“翻页”**（不知道是不是考虑到视障用户记页码对应内容比较方便，这么设计）
     + Android有滚动的概念，安卓的双指滚动实际上和我们平时的**“滚动”**表现是一致的
     + 基于这种最基本的交互模式的不同，iOS有个非常常见的问题，对我们现在已经非常熟悉的操作**“下拉刷新”**其实iOS用户是很不方便的，
       + 翻页不能直接触发刷新，要看实现逻辑，
       + 即使实现了刷新，但是每一页码对应的内容就变化了，其实达不到记忆页码对应内容的效果
       + 要额外提示用户，“总共三页，当前第一页，向下滚动到第0页刷新”
     + 另外针对Android手机，其实市面上的读屏软件也是五花八门，能够支持的手势十分强大，比如Z操作是回到主屏幕，反Z操作是触发编辑模式等等，异常强大和丰富，这部分的手势基本上都是TTS自行支持，App端直接忽略就好
   + 解决方案：因为我们App并不是内容类的App，所以没有那么强的信息更新诉求，虽然首页有这个操作，但是不操作影响也不大，所以就没有强提示用户了。

### 2.错误提示

   + 这个地方是比较容易忽略的地方，尤其是在UI输入的时候，很多时候，我们在明眼人的设计里面，通过按钮变灰，边框变红，文字置灰等等，可以用来提示很多信息，但是面对无障碍的设计的时候，这一些提示是达不到传递信息的目的的，所以需要有额外处理
   + 解决方案：关键节点控制，典型的Form表单提交的时候，在焦点放在提交按钮的时候，
     + 需要在这个按钮上提示用户输入是否成功，以及如果不成功的话是哪一个Label出了问题，以及问题是什么，这样至少兜底能够保证用户在关键的提交流程，会获得足够的信息，保证流程能够走下去
     + 另外可以通过`AccessibilityInfo.announceForAccessibility(msg)`方法来主动发送小tips的提示，比如说红框周边的文案，这样在不切换焦点的时候，用户也能收到对于的错误提示

### 3.逻辑

   + 这种情况其实也是很普遍而且不容易发现的，因为项目总是先上线迭代满足功能，然后再来无障碍优化，但是这中间就会涉及到不少之前根本没有考虑过视障用户的问题，比如说图文教程，视频教程，语音读屏幕上的文字来校验身份等等，这些都是视障用户没法用，但是前期都没考虑过的问题。
   + 解决方案：寻求视障用户的替代方案，具体情况还是得依照用户场景而定，比如微众银行App就针对刷脸验证身份，专门提供了一个语音提示，指导怎么移动手机来对准正脸

### 4.跑马灯提示

   + 这也是一个明眼人下意识会忽略的问题，典型的就是宣传位，尤其是Banner位，通常Banner位有多张图，但是依据TTS的不一致，用户不一定能意识到这是个Banner，可能读屏的时候，只会读出这是一张图片（如果Banner位的辅助说明不足的话），而且也不知道还有其他图片，那么这种事情，Banner自动轮播切图片了，需不需要自动读新的内容，主动告诉用户图片切换了呢？这里就会有个问题，如果通知用户，那么Banner一直切，TTS就一直念，很吵。如果不通知，剩下的图片其实是无法触达用户的
   + 解决方案：优先保证体验，不念，因为在RN现有能力里面，是不能监控到当前焦点在哪里的，焦点变化并没有对应的回调函数，比较理想的状态是找到方法能够拿到当前焦点的位置和回调，判断焦点在Banner位的时候，再进行提醒。PS：之前提到的RN支持的控件类型，并没有Banner这种类型


## 焦点控制

焦点控制是一个在无障碍里面比较重要的部分，所以单独列开来说

### 1.行内链—要改--已有解决方案
   + 问题案例：这个问题在RN的iOS上非常明显，表现是在于这样一种代码结构下，在iOS开启VoiceOver的情况下，整行字是同一个焦点，即**“文案1文案2文案3文案4”**整个一句话作为一个可触发的焦点，这样的情况下，`onPress`会触发的函数是不一定的，如果文案是英文的话，那么会触发`debugger4`，但是如果文案是中文的话，会和文字的字数有关，大概率触发的回调函数会是**字数最多**的那个。

   + ```jsx
     <Text onPress={()=>{console.log('debugger1')}}>
         文案1
         <Text onPress={()=>{console.log('debugger2')}}>
             文案2
             <Text onPress={()=>{console.log('debugger3')}}>
                 文案3
                 <Text onPress={()=>{console.log('debugger4')}}>
                 	文案4
                 </Text>
             </Text>
         </Text>
     </Text>
     ```

   + 解决方案：因为焦点聚合，所以只可能触发某一个回调函数，通过无障碍单独的响应监听，添加指定的想要处理的回调，这个时候直接监听最外层的Text，把外层要处理的回调来监听

   + ```jsx
     <Text 
         onPress={()=>{console.log('debugger1')}} 
         accessible={true} 
         accessibilityActions=[{ name: 'activate' }]  
         onAccessibilityAction: (event) => {
     		if (event.nativeEvent.actionName === 'activate') {
     			console.log('debugger4')
             }
         }>
         文案1
         <Text onPress={()=>{console.log('debugger2')}}>
             文案2
             <Text onPress={()=>{console.log('debugger3')}}>
                 文案3
                 <Text onPress={()=>{console.log('debugger4')}}>
                 	文案4
                 </Text>
             </Text>
         </Text>
     </Text>
     ```

### 2.弹窗穿透：

   + 问题案例：在一般的App设计中，弹窗是一个非常常见的问题，我们通过弹窗+遮罩层，可以实现用户聚焦在当前弹窗，聚焦用户的操作，做到流程的控制或者是强聚焦用户视觉作用，被遮罩层盖住的部分，因为点击事件被弹窗阻断，所以不会误操作被遮罩层盖住部分。但是在无障碍的操作上却不是这样的，即使被遮罩层盖住之后，但是对于TTS而言，节点依然存在，所以TTS依然是可以聚焦到被遮罩层盖住的元素。这就是典型的弹窗穿透

   + 解决方案：在弹窗出现的时候，判断是否有遮罩层，如果有遮罩层的话，在被盖住的节点的最外层的`<View>`上面添加这两个属性，即可屏蔽所有

   + ```jsx
     <View  accessibilityElementsHidden={true} importantForAccessibility={'no-hide-descendants'} ></View>
     ```

   + 注意：

     + 中文的React-native网站上对于`importantForAccessibility`属性的demo是错误的，'no-hide-descendants'这个属性最后有一个s，不能漏掉
     + 如果在你的项目中使用了`react-navigation`，那么你需要添加属性的`View`有可能是在`react-navigation`中`render`的，这种情况下，需要额外处理。比如我们的项目，因为使用的是旧版本的`react-navigation`，所以需要额外改包里面的代码。

### 3.页面穿透

   + 问题案例：这个问题很特别，基本上只会出现在iOS上面，原因和App本身页面切换的逻辑是有关系的，如果App在切换页面的时候，旧的页面没有消失，只是被覆盖的话，有小几率会出现VoiceOver的焦点还在旧的页面上，也就是视觉上切换到了新页面，但是交互被保留在旧的页面上了

   + 解决方案：通过设置`accessibilityViewIsModal`属性来禁止被覆盖的元素的响应（因为是当前页面的兄弟元素），另外，其实在切换页面的时候，应该主动切换焦点到新页面上，这部分会在**焦点控制**中说明

  + ```jsx
       <View accessibilityViewIsModal={true} ></View>
       ```

### 4.焦点分拆

   + 问题案例：这个问题在iOS上面特别明显，和上文提到的`Text`问题表现有点类似。表现就在于

   + ```jsx
     <TouchableOpacity onPress={onPress1}>
     	<View>
         	<TouchableOpacity onPress={onPress2}>
             	<View>
                 	xxxx
                 </View>
             </TouchableOpacity>
             <TouchableOpacity onPress={onPress3}>
             	<View>
                 	xxxx
                 </View>
             </TouchableOpacity>
         </View>
     </TouchableOpacity>
     ```

     在这种嵌套的按钮结构中，RN的iOS是无法响应里面的onPress2事件和onPress3事件，只会响应到外部的onPress1事件，原因就是在`node_modules/react-native/React/Views/RCTView.m`这个文件中的`- (BOOL)isAccessibilityElement`判断是有问题的，并不会主动向下寻找其他可以触发的节点。所以这个地方其实是RN本身的bug，我们的同事已经提了<https://github.com/facebook/react-native/pull/29142>这个PR

   + 解决方案：通过新增分割焦点属性，主动分割字节点出来使用

   + ```jsx
     <TouchableOpacity onPress={onPress1} accessibilitySplitFocus={true}>
     	<View>
         	<TouchableOpacity onPress={onPress2}>
             	<View accessible={true}>
                 	不推荐的做法
                 </View>
             </TouchableOpacity>
             <TouchableOpacity onPress={onPress3} pointerEvents={'box-only'}>
             	<View>
                 	推荐的做法
                 </View>
             </TouchableOpacity>
         </View>
     </TouchableOpacity>
     ```
     这里特别说一下，这么改的目的：`accessibilitySplitFocus`这个属性是用来分割焦点的，仅在iOS上生效，设置之后，里面的字元素如果设置了`accessible`这个属性，那么就可以获取到焦点了。但是这个地方的焦点是不包括字元素的`<TouchableOpacity>`的，在`<View accessible={true}>`的情况下能够获取到焦点，确实可以通过点击第一个`<View>`来触发`onPress2`，但这么做会引起其他的问题

     + 在**Android**上，**“不推荐做法”**这个按钮会有两个焦点，一个朗读为**“不推荐做法”**，焦点是在`<View>`上面，一个朗读为**“不推荐做法，按钮”**，这个焦点是在`<TouchableOpacity>`上面；但是在**iOS**的表现，是只有一个焦点为**“不推荐做法”**，就是这个`<View>`
     + 所以为了解决这个问题，我们把`<TouchableOpacity>`的`pointEvents`事件向下传递（这个地方也是需要改RN的代码）因为里面的`<View>`虽然不能被TTS找到，因为不支持无障碍，但是可以响应事件，这样就使得`<TouchableOpacity>`被响应到，而被TTS聚焦。

### 5.焦点跳转

   + 问题案例：页面切换，弹窗弹出这两种交互形式，本质上都是替换了用户交互区域，所以在这个过程中，一定要给予用户足够的提示，告诉用户可操作区域是变化了的。所以在切换页面和弹窗的时候（包括全屏遮罩，半屏的键盘出现，广告位出现等等）需要主动把焦点跳转到对应的操作title。需要主动告知用户当前UI的变化，不然用户就很难理解上一步的操作是干了什么，产生了什么效果。一个简单的例子就是二次确认，当出现二次确认按钮的时候，需要把焦点跳转到弹窗的文字上面，不然用户原来的可操作区域变为不可操作了（上文提到了弹窗点击穿透问题解决之后）用户需要手动寻找可操作区域，这个体验就非常的反人类。

   + 解决方案：通过主动寻找到对应的焦点，通常是`<Text>`来作为需要读取的文案（这个地方特别注意，如果把焦点放在自定义组件上面，可能会导致焦点找不到这个组件，或者不知道朗读什么）这样就可以在跳转或者弹窗的时候，有对应的焦点变化。

   + ```jsx
     import { AccessibilityInfo, findNodeHandle } from 'react-native'
     
     <Text 
         accessible={true} 
         ref={(ref)=>{
           if(ref){
             const reactTag = findNodeHandle(ref)
             AccessibilityInfo.setAccessibilityFocus(reactTag)
           }        
     }}></Text>
     ```

   + 注意事项：如果使用了`react-navigation`那么这个`<Text>`可能不是在你自己的代码里面，需要额外处理。我们这边因为是使用了版本非常旧的`react-navigation`所以是需要改库文件的。